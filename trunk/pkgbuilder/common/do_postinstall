# Copyright 2003 Antonio G. Muñoz, tomby (AT) tomby.homemelinux.org
# Distributed under the terms of the GNU General Public License v2
# $Header: /cvsroot/pkgbuilder/pkgbuilder/common/Attic/do_postinstall,v 1.5 2003/12/03 23:25:50 tomby Exp $

do_postinstall() {
    cd $PKG_SRC

    mkdir -p $PKG_DOC

    cp $PKG_DOC_FILES $PKG_DOC
    find $PKG_DOC -type f -exec chmod 644 {} \;
    find $PKG_DOC -type d -exec chmod 755 {} \;
    
    strip_all $PKG_DEST

    gzip_man $PKG_DEST$PKG_PREFIX/man
    
    if [ -f $PKG_DEST$PKG_PREFIX/info/dir ] ; then
        rm -f $PKG_DEST$PKG_PREFIX/info/dir
    fi

    gzip_info $PKG_DEST$PKG_PREFIX/info
    
    for config in $PKG_CONFIG_FILES ; do
        mv $PKG_DEST$config $PKG_DEST$config.new
    done
    
        mkdir -p $PKG_DEST/install

    cat $PKG_HOME/files/slack-desc > $PKG_DEST/install/slack-desc
    
    if [ "$PKG_CONFIG_FILES" != "" ] ; then
        cat $PKGBUILDER_HOME/examples/doinst.sh > $PKG_DEST/install/doinst.sh
        
        cat EOF > $PKG_DEST/install/doinst.sh << "EOF"
#!/bin/sh
config() {
  NEW="$1"
  OLD="`dirname $NEW`/`basename $NEW .new`" 
  # If there's no config file by that name, mv it over:
  if [ ! -r $OLD ]; then
    mv $NEW $OLD
  elif [ "`cat $OLD | md5sum`" = "`cat $NEW | md5sum`" ]; then # toss the redundant copy
    rm $NEW
  fi 
  # Otherwise, we leave the .new copy for the admin to consider...
}
EOF
        
        for config in $PKG_CONFIG_FILES ; do
            echo "config $config" >> $PKG_DEST/install/doinst.sh
        done 
    fi
  
    if [ -f $PKG_HOME/files/doinst.sh-$PKG_VERSION ] ; then
        cat $PKG_HOME/files/doinst.sh-$PKG_VERSION >> $PKG_DEST/install/doinst.sh
    elif [ -f $PKG_HOME/files/doinst.sh ] ; then
        cat $PKG_HOME/files/doinst.sh >> $PKG_DEST/install/doinst.sh
    fi
}
